FROM node:16.15-alpine3.14

COPY ./kcat /usr/src/kcat

ENV BUILD_DEPS bash make gcc g++ cmake curl pkgconfig perl bsd-compat-headers zlib-dev lz4-dev openssl-dev curl-dev

ENV RUN_DEPS libcurl lz4-libs ca-certificates

# Kerberos requires a default realm to be set in krb5.conf, which we can't
# do for obvious reasons. So skip it for now.
#ENV BUILD_DEPS_EXTRA cyrus-sasl-dev
#ENV RUN_DEPS_EXTRA libsasl heimdal-libs krb5

RUN echo Installing ; \
  apk add --no-cache --virtual .dev_pkgs $BUILD_DEPS $BUILD_DEPS_EXTRA && \
  apk add --no-cache $RUN_DEPS $RUN_DEPS_EXTRA && \
  echo Building && \
  cd /usr/src/kcat && \
  rm -rf tmp-bootstrap && \
  echo "Source versions:" && \
  grep ^github_download ./bootstrap.sh && \
  ./bootstrap.sh && \
  mv kcat /usr/bin/ ; \
  echo Cleaning up ; \
  cd / ; \
  rm -rf /usr/src/kcat; \
  apk del .dev_pkgs ; \
  rm -rf /var/cache/apk/*

#RUN kcat -V

ENTRYPOINT ["kcat"]


RUN mkdir /app
WORKDIR /app

COPY . .
RUN chmod +x health_check.sh


CMD ["node", "api.js"]
EXPOSE 3000
